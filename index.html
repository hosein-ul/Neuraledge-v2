import React, { useEffect, useMemo, useRef, useState } from "react";
// Optional libraries (available in the preview runtime). If an import fails in your local setup, replace with plain Tailwind UI.
import { ArrowUpRight, ArrowDownRight, RefreshCw, Copy, Share2, Link as LinkIcon, Clock3 } from "lucide-react";
import {
  AreaChart,
  Area,
  XAxis,
  YAxis,
  CartesianGrid,
  Tooltip,
  Legend,
  ResponsiveContainer,
} from "recharts";

// ------------------------------
// Config
// ------------------------------
const DEFAULT_CHAIN = "ethereum-11155111"; // Sepolia per original code
const ALLORA_V2_API_BASE = (chainId) => `https://api.allora.network/v2/allora/consumer/${chainId}`;

// If you have an env or runtime-provided key, expose it on window.ALLORA_API_KEY
const ALLORA_API_KEY = typeof window !== "undefined" && window.ALLORA_API_KEY
  ? window.ALLORA_API_KEY
  : "UP-662ebd02310c4509bf66dc1e"; // fallback to provided demo key

const DEFAULT_REFRESH_MS = 30000;
const MAX_POINTS = 120; // keep ~1 hour with 30s refresh

// Topic map mirrors the original file, but you can extend safely here
const TOPIC_CONFIG = {
  "BTC/USD": {
    "1 day": { id: 69, coinGeckoId: "bitcoin", name: "BTC/USD - 1 Day Prediction" },
    "8h": { id: 42, coinGeckoId: "bitcoin", name: "BTC/USD - 8 Hour Prediction" },
    "5min": { id: 14, coinGeckoId: "bitcoin", name: "BTC/USD - 5 Minute Prediction" },
  },
  "ETH/USD": {
    "8h": { id: 41, coinGeckoId: "ethereum", name: "ETH/USD - 8 Hour Prediction" },
    "5min": { id: 13, coinGeckoId: "ethereum", name: "ETH/USD - 5 Minute Prediction" },
  },
  "SOL/USD": {
    "8h": { id: 38, coinGeckoId: "solana", name: "SOL/USD - 8 Hour Prediction" },
    "5min": { id: 37, coinGeckoId: "solana", name: "SOL/USD - 5 Minute Prediction" },
    "10min": { id: 5, coinGeckoId: "solana", name: "SOL/USD - 10 Minute Prediction" },
  },
  "ETH/USDC": {
    "6h": { id: 46, coinGeckoId: "ethereum", name: "ETH/USDC - 6 Hour Prediction" },
  },
  BNB: {
    "20min": { id: 8, coinGeckoId: "binancecoin", name: "BNB/USD - 20 Minute Prediction" },
  },
};

// ------------------------------
// Helpers
// ------------------------------
const fmtUsd = (n) => {
  if (n === null || n === undefined || Number.isNaN(n)) return "—";
  try {
    return `$${Number(n).toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
  } catch {
    return `$${n}`;
  }
};

const pctColor = (pct) => {
  if (pct === null || pct === undefined || Number.isNaN(pct)) return "text-gray-400";
  if (pct > 0.1) return "text-emerald-400";
  if (pct < -0.1) return "text-rose-400";
  return "text-gray-300";
};

const calcChangePct = (live, predicted) => {
  const l = Number(live), p = Number(predicted);
  if (!l || !p) return null;
  return ((p - l) / l) * 100;
};

const useInterval = (cb, delay) => {
  const saved = useRef(cb);
  useEffect(() => { saved.current = cb; }, [cb]);
  useEffect(() => {
    if (delay === null) return;
    const id = setInterval(() => saved.current(), delay);
    return () => clearInterval(id);
  }, [delay]);
};

const coingeckoSimple = async (coinGeckoId) => {
  const url = `https://api.coingecko.com/api/v3/simple/price?ids=${coinGeckoId}&vs_currencies=usd`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`CoinGecko ${res.status}`);
  const j = await res.json();
  return j?.[coinGeckoId]?.usd ?? 0;
};

const fetchAllora = async (topicId, chainId = DEFAULT_CHAIN) => {
  const apiUrl = `${ALLORA_V2_API_BASE(chainId)}?allora_topic_id=${topicId}`;
  const res = await fetch(apiUrl, {
    headers: { accept: "application/json", "x-api-key": ALLORA_API_KEY },
  });
  if (!res.ok) throw new Error(`Allora ${res.status}`);
  const j = await res.json();
  const v = j?.data?.inference_data?.network_inference_normalized;
  const n = Number(v);
  return Number.isFinite(n) && n > 0 ? n : 0;
};

// Small in-memory cache to be polite to APIs during rapid changes
const makeCache = (ttlMs = 10_000) => {
  const store = new Map();
  return {
    async get(key, loader) {
      const now = Date.now();
      const hit = store.get(key);
      if (hit && now - hit.t < ttlMs) return hit.v;
      const v = await loader();
      store.set(key, { v, t: now });
      return v;
    },
    clear() { store.clear(); },
  };
};

const cache = makeCache(12_000);

// ------------------------------
// UI Bits
// ------------------------------
function Pill({ active, children, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`px-4 py-2 rounded-xl text-sm font-semibold border transition active:scale-[0.98] ${
        active
          ? "bg-indigo-600 text-white border-indigo-500 shadow-xl shadow-indigo-600/40 ring-4 ring-indigo-500/20"
          : "bg-gray-800/70 text-gray-200 border-gray-700 hover:bg-indigo-700/40 hover:text-white"
      }`}
    >
      {children}
    </button>
  );
}

function Stat({ label, value, hint, valueClass = "" }) {
  return (
    <div className="p-5 rounded-2xl border border-gray-700 bg-gray-800/70 shadow-lg">
      <div className="text-sm text-gray-400 mb-1">{label}</div>
      <div className={`text-4xl font-extrabold ${valueClass}`}>{value}</div>
      {hint ? <div className="text-xs text-gray-500 mt-1">{hint}</div> : null}
    </div>
  );
}

function StatusBanner({ status }) {
  if (!status) return null;
  const { kind, text } = status;
  const cls = {
    loading: "bg-yellow-900 text-yellow-200 border border-yellow-600",
    ok: "bg-emerald-900 text-emerald-200 border border-emerald-700",
    error: "bg-rose-900 text-rose-200 border border-rose-700",
  }[kind];
  return (
    <div className={`p-3 rounded-xl text-center text-sm font-medium ${cls}`}>{text}</div>
  );
}

// ------------------------------
// Main Component
// ------------------------------
export default function AlloraPredictionApp() {
  // Restore selection from URL or localStorage
  const urlParams = new URLSearchParams(typeof window !== "undefined" ? window.location.search : "");
  const urlAsset = urlParams.get("asset");
  const urlTf = urlParams.get("tf");

  const [asset, setAsset] = useState(urlAsset && TOPIC_CONFIG[urlAsset] ? urlAsset : "BTC/USD");
  const availableTFs = Object.keys(TOPIC_CONFIG[asset] || {});
  const [timeframe, setTimeframe] = useState(
    urlTf && availableTFs.includes(urlTf) ? urlTf : availableTFs[0]
  );

  const [refreshMs, setRefreshMs] = useState(DEFAULT_REFRESH_MS);
  const [auto, setAuto] = useState(true);
  const [chainId, setChainId] = useState(DEFAULT_CHAIN);
  const [status, setStatus] = useState({ kind: "loading", text: "Booting up the oracle hamsters..." });

  const conf = TOPIC_CONFIG[asset]?.[timeframe];

  const [live, setLive] = useState(null);
  const [pred, setPred] = useState(null);
  const [points, setPoints] = useState([]); // {t, live, pred}
  const [lastUpdated, setLastUpdated] = useState(null);

  const changePct = useMemo(() => calcChangePct(live, pred), [live, pred]);

  // Fetch once and on dependency change
  const fetchOnce = async () => {
    if (!conf) return;
    setStatus({ kind: "loading", text: `Fetching ${conf.name}...` });
    try {
      const [liveVal, predVal] = await Promise.all([
        cache.get(`cg:${conf.coinGeckoId}`, () => coingeckoSimple(conf.coinGeckoId)),
        cache.get(`al:${conf.id}:${chainId}`, () => fetchAllora(conf.id, chainId)),
      ]);
      setLive(liveVal || 0);
      setPred(predVal || 0);
      setPoints((prev) => {
        const next = [
          ...prev,
          { t: Date.now(), live: Number(liveVal || 0), pred: Number(predVal || 0) },
        ].slice(-MAX_POINTS);
        return next;
      });
      setLastUpdated(new Date());
      setStatus({ kind: "ok", text: `${conf.name} updated successfully.` });
    } catch (e) {
      console.error(e);
      setStatus({ kind: "error", text: `Fetch failed: ${e.message}` });
    }
  };

  useEffect(() => {
    // Update URL for shareability
    const q = new URLSearchParams({ asset, tf: timeframe });
    const newUrl = `${window.location.pathname}?${q.toString()}`;
    window.history.replaceState(null, "", newUrl);
  }, [asset, timeframe]);

  useEffect(() => {
    // reset points on selection change
    setPoints([]);
    fetchOnce();
  }, [asset, timeframe, chainId]);

  useInterval(() => { if (auto) fetchOnce(); }, auto ? refreshMs : null);

  const copyLink = async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      setStatus({ kind: "ok", text: "Permalink copied to clipboard." });
    } catch {
      setStatus({ kind: "error", text: "Copy failed. You can manually copy the URL." });
    }
  };

  const share = async () => {
    try {
      if (navigator.share) {
        await navigator.share({
          title: "Allora Prediction",
          text: `${asset} • ${timeframe}`,
          url: window.location.href,
        });
        setStatus({ kind: "ok", text: "Shared." });
      } else {
        copyLink();
      }
    } catch {}
  };

  const headerTitle = conf?.name || "Awaiting selection";

  // Chart data formatting
  const chartData = useMemo(() => {
    return points.map((p) => ({
      time: new Date(p.t).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" }),
      Live: p.live,
      Predicted: p.pred,
    }));
  }, [points]);

  return (
    <div className="min-h-screen w-full bg-gradient-to-br from-gray-900 via-gray-950 to-black text-gray-100">
      <div className="max-w-7xl mx-auto px-4 py-8">
        {/* Header */}
        <header className="text-center mb-8">
          <h1 className="text-5xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-indigo-200">
            Allora Prediction Platform
          </h1>
          <p className="mt-2 text-indigo-300">Pick an asset, choose a timeframe, watch the oracle whisper.</p>
        </header>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Left: Controls */}
          <aside className="lg:col-span-1 bg-gray-900/70 backdrop-blur p-6 rounded-2xl border border-gray-800 shadow-2xl space-y-8">
            <div>
              <h2 className="text-xl font-bold text-indigo-400 border-b border-gray-800 pb-3">1. Select Asset Pair</h2>
              <div className="mt-4 grid grid-cols-2 gap-2">
                {Object.keys(TOPIC_CONFIG).map((k) => (
                  <Pill key={k} active={k === asset} onClick={() => setAsset(k)}>{k}</Pill>
                ))}
              </div>
            </div>

            <div>
              <h2 className="text-xl font-bold text-indigo-400 border-b border-gray-800 pb-3">2. Select Timeframe</h2>
              <div className="mt-4 grid grid-cols-3 gap-2">
                {availableTFs.map((tf) => (
                  <Pill key={tf} active={tf === timeframe} onClick={() => setTimeframe(tf)}>{tf}</Pill>
                ))}
              </div>
            </div>

            <div className="bg-black/40 p-4 rounded-xl border border-indigo-700/40">
              <h3 className="text-sm font-semibold text-indigo-300 mb-2">Your Selection</h3>
              <div className="text-sm space-y-1">
                <div><span className="text-gray-400">Asset:</span> <span className="font-bold">{asset}</span></div>
                <div><span className="text-gray-400">Timeframe:</span> <span className="font-bold">{timeframe}</span></div>
                <div className="font-mono text-xs"><span className="text-gray-400">Topic ID:</span> {conf?.id ?? "—"}</div>
              </div>
            </div>

            <div className="space-y-3">
              <h2 className="text-xl font-bold text-indigo-400 border-b border-gray-800 pb-3">3. Preferences</h2>
              <div className="flex items-center justify-between">
                <label className="text-sm text-gray-300">Auto refresh</label>
                <button
                  onClick={() => setAuto((a) => !a)}
                  className={`px-3 py-1 rounded-lg border text-sm ${auto ? "bg-emerald-600/70 border-emerald-500" : "bg-gray-800 border-gray-700"}`}
                >
                  {auto ? "On" : "Off"}
                </button>
              </div>
              <div>
                <label className="text-sm text-gray-300">Refresh interval: {Math.round(refreshMs / 1000)}s</label>
                <input
                  type="range"
                  min={5}
                  max={120}
                  value={Math.round(refreshMs / 1000)}
                  onChange={(e) => setRefreshMs(Number(e.target.value) * 1000)}
                  className="w-full"
                />
              </div>
              <div>
                <label className="text-sm text-gray-300">Chain ID</label>
                <select
                  value={chainId}
                  onChange={(e) => setChainId(e.target.value)}
                  className="mt-1 w-full bg-gray-900 border border-gray-700 rounded-lg p-2 text-sm"
                >
                  <option value="ethereum-11155111">ethereum-11155111 (Sepolia)</option>
                </select>
              </div>
            </div>

            <div className="flex items-center gap-2 pt-2">
              <button onClick={fetchOnce} className="platform-btn px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-500 active:scale-[0.98] font-semibold flex items-center gap-2">
                <RefreshCw className="w-4 h-4" /> Refresh
              </button>
              <button onClick={copyLink} className="px-4 py-2 rounded-xl bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-[0.98] font-semibold flex items-center gap-2">
                <LinkIcon className="w-4 h-4" /> Copy link
              </button>
              <button onClick={share} className="px-4 py-2 rounded-xl bg-gray-800 border border-gray-700 hover:bg-gray-700 active:scale-[0.98] font-semibold flex items-center gap-2">
                <Share2 className="w-4 h-4" /> Share
              </button>
            </div>

            <p className="text-[10px] text-gray-500 pt-2">Pro tip: set window.ALLORA_API_KEY at runtime to avoid hardcoding secrets in client bundles. Never ship real keys in public builds.</p>
          </aside>

          {/* Right: Data and Charts */}
          <main className="lg:col-span-2 space-y-5">
            <div className="bg-gray-900/70 p-6 rounded-2xl border-t-4 border-indigo-500 shadow-xl">
              <h2 className="text-3xl md:text-4xl font-extrabold text-center">{headerTitle}</h2>
              <div className="mt-3">
                <StatusBanner status={status} />
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <Stat label="Live Price (USD)" value={fmtUsd(live)} valueClass="text-emerald-400" />
              <Stat label="Predicted Value" value={fmtUsd(pred)} valueClass="text-indigo-300" />
              <Stat
                label="Expected Change"
                value={changePct === null ? "—" : (
                  <span className={`inline-flex items-center gap-1 ${pctColor(changePct)}`}>
                    {changePct > 0 ? <ArrowUpRight className="w-6 h-6" /> : changePct < 0 ? <ArrowDownRight className="w-6 h-6" /> : null}
                    {`${changePct.toFixed(2)}%`}
                  </span>
                )}
                hint={lastUpdated ? `Last updated ${lastUpdated.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit", second: "2-digit" })}` : ""}
              />
            </div>

            {/* Chart */}
            <div className="p-6 rounded-2xl border border-gray-800 bg-gray-900/70 shadow-lg">
              <div className="flex items-center justify-between mb-3">
                <div className="text-sm text-gray-400 flex items-center gap-2"><Clock3 className="w-4 h-4" /> Live vs Predicted</div>
              </div>
              <div className="h-80">
                <ResponsiveContainer width="100%" height="100%">
                  <AreaChart data={chartData} margin={{ left: 8, right: 8, top: 8, bottom: 8 }}>
                    <defs>
                      <linearGradient id="gLive" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#10b981" stopOpacity={0.35} />
                        <stop offset="100%" stopColor="#10b981" stopOpacity={0.02} />
                      </linearGradient>
                      <linearGradient id="gPred" x1="0" y1="0" x2="0" y2="1">
                        <stop offset="0%" stopColor="#818cf8" stopOpacity={0.35} />
                        <stop offset="100%" stopColor="#818cf8" stopOpacity={0.02} />
                      </linearGradient>
                    </defs>
                    <CartesianGrid strokeOpacity={0.15} />
                    <XAxis dataKey="time" tick={{ fontSize: 12 }} />
                    <YAxis tick={{ fontSize: 12 }} domain={["dataMin", "dataMax"]} />
                    <Tooltip formatter={(v) => fmtUsd(v)} />
                    <Legend />
                    <Area type="monotone" dataKey="Live" stroke="#10b981" fill="url(#gLive)" strokeWidth={2} />
                    <Area type="monotone" dataKey="Predicted" stroke="#818cf8" fill="url(#gPred)" strokeWidth={2} />
                  </AreaChart>
                </ResponsiveContainer>
              </div>
            </div>

            {/* Details */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="p-5 rounded-2xl border border-gray-800 bg-gray-900/70">
                <h3 className="text-lg font-semibold text-indigo-300 mb-2">Oracle Details</h3>
                <ul className="text-sm text-gray-300 space-y-1">
                  <li><span className="text-gray-500">Chain:</span> {chainId}</li>
                  <li><span className="text-gray-500">Topic ID:</span> {conf?.id ?? "—"}</li>
                  <li><span className="text-gray-500">Asset:</span> {asset}</li>
                  <li><span className="text-gray-500">Timeframe:</span> {timeframe}</li>
                  <li><span className="text-gray-500">CoinGecko ID:</span> {conf?.coinGeckoId ?? "—"}</li>
                </ul>
                <p className="text-[10px] text-gray-500 mt-3">Data is for demonstration and research. Not financial advice.</p>
              </div>

              <div className="p-5 rounded-2xl border border-gray-800 bg-gray-900/70">
                <h3 className="text-lg font-semibold text-indigo-300 mb-2">Tips</h3>
                <ul className="text-sm text-gray-400 list-disc pl-4 space-y-1">
                  <li>Use the Copy link button to share your current selection.</li>
                  <li>Adjust the refresh interval to control API usage.</li>
                  <li>Pin this page as a PWA and view it on mobile as a dashboard.</li>
                </ul>
              </div>
            </div>

            <footer className="text-center text-xs text-gray-500 pt-4">
              <p>Prediction data provided by Allora Oracle • Live price via CoinGecko Simple Price</p>
            </footer>
          </main>
        </div>
      </div>
    </div>
  );
}
